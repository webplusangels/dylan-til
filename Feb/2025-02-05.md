## 2025-02-05

### ê°œìš”

ì˜¤ëŠ˜ì€ ì–´ì œì— ì´ì–´ nginxë¥¼ ë°±ì—”ë“œì™€ ì—°ê²°í•˜ê³  ì´ë¥¼ í”„ë¡ íŠ¸ì™€ ì—°ê²°í•´ ìµœì¢…ì ìœ¼ë¡œ ë°±ì—”ë“œì—ì„œì˜ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ ê³µë¶€í–ˆë‹¤.

ë¨¼ì € êµ¬ìƒí•œ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

<img width="930" alt="Image" src="https://github.com/user-attachments/assets/c1673686-8f53-4d92-b6dd-82256528513d" />

ì—¬ëŸ¬ ë²ˆì˜ ì‚½ì§ˆ ëì— ë‚´ê°€ ì´í•´í•œ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

### blue-green ë°°í¬

ë¨¼ì € ë¸”ë£¨ ê·¸ë¦° ë°°í¬ ë°©ì‹ì˜ í•µì‹¬ì€ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•´ ë‘ ê°œì˜ í™˜ê²½ì„ ì¡´ì¬ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.

ê° í™˜ê²½(Blue, Green)ì€ ë™ì¼í•œ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì„œë¡œ ë‹¤ë¥¸ ë²„ì „ì´ ë™ì‹œì— ìš´ì˜ë  ìˆ˜ ìˆë„ë¡ êµ¬ì„±ëœë‹¤. ì´ë¥¼ ìœ„í•´ ì»¨í…Œì´ë„ˆë¥¼ í™˜ê²½ìœ¼ë¡œ ì •ì˜í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ë™ì‹œì— ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡ í•œë‹¤.

ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ë‚´ì— `Dockerfile`ì„ ë§Œë“¤ì–´ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•œë‹¤.

```Dockerfile
# Node ì´ë¯¸ì§€
FROM node:23.6-alpine

# ë””ë ‰í„°ë¦¬ ì„¤ì •
WORKDIR /app

# package.json ë³µì‚¬
COPY package*.json ./

# npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ (production)
RUN npm ci --only=production

# ì½”ë“œ ë³µì‚¬
COPY . .

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production
ENV PORT=8000

# ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["node", "server.js"]

# í¬íŠ¸
EXPOSE 8000
```

> `.dockerignore` íŒŒì¼ì„ í†µí•´ í”„ë¡œì íŠ¸ ë‚´ì˜ ë¶ˆí•„ìš”í•œ íŒŒì¼ë“¤ì„ ì œì™¸í•  ìˆ˜ ìˆë‹¤.

> EC2ì˜ ubuntu í™˜ê²½ì€ linux/amd64ë¼ ë§¥ ì‹¤ë¦¬ì½˜ì—ì„œ ë§Œë“  ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê¸° ìœ„í•´ì„  ë¹Œë“œ ê³¼ì •ì—ì„œ ë³„ë„ì˜ ì²˜ë¦¬ê°€ í•„ìš”í•˜ë‹¤. [buildx ì°¸ê³ ](https://kim-dragon.tistory.com/152)

í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³ , ë°°í¬ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ Docker Hubì— ë¯¸ë¦¬ ì´ë¯¸ì§€ë¥¼ ì˜¬ë ¤ë‘ë©´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ ë¶ˆí•„ìš”í•œ ë¹Œë“œ ê³¼ì •ì„ ìƒëµí•  ìˆ˜ ìˆë‹¤.

```bash
docker buildx build --platform linux/amd64 -t nimwver/ktb-backend:latest --push .
```

ë‹¤ìŒìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•  docker-compose.yml íŒŒì¼ì´ í•„ìš”í•˜ë‹¤. í•´ë‹¹ íŒŒì¼ì—” ë¸”ë£¨, ê·¸ë¦° ì»¨í…Œì´ë„ˆ ë¿ë§Œ ì•„ë‹ˆë¼ nginx ì´ë¯¸ì§€ë„ ê°™ì´ ì˜¬ë¼ê°€ ë°±ì—”ë“œ ì„œë²„ë¥¼ 80ë²ˆ í¬íŠ¸ì— ë°”ìš´ë”©í•œë‹¤.

```yaml
version: "3.8"

services:
  nginx:
    image: nginx
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    restart: always
    depends_on:
      - backend_blue
      - backend_green

  backend_blue:
    image: nimwver/ktb-backend:latest
    container_name: backend_blue
    ports:
      - "8000:8000"
    restart: always

  backend_green:
    image: nimwver/ktb-backend:latest
    container_name: backend_green
    ports:
      - "8001:8000" # Blueì™€ Green ì»¨í…Œì´ë„ˆê°€ ë²ˆê°ˆì•„ê°€ë©° 8000ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ Nginxì—ì„œ ì„¤ì •í•¨
    restart: always
```

nginxì˜ ì„¤ì • íŒŒì¼ë„ ìˆ˜ì •ì´ í•„ìš”í•˜ë‹¤.

```conf
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸(deploy.sh)ì— ì˜í•´ í˜„ì¬ í™œì„±í™”ëœ ì»¨í…Œì´ë„ˆ(backend_blue ë˜ëŠ” backend_green)ë¡œ ë™ì ìœ¼ë¡œ ì„¤ì •ë¨
    upstream backend {
        # í˜„ì¬ëŠ” backend_blue ì»¨í…Œì´ë„ˆë§Œ ë“±ë¡ë˜ì–´ ìˆìŒ
        server backend_blue:8000;
    }

    server {
        # nginxê°€ 80ë²ˆ í¬íŠ¸ì—ì„œ HTTP ìš”ì²­ì„ ìˆ˜ì‹ 
        listen 80;

        location / {
            # í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ í™œì„±í™”ëœ backend ì»¨í…Œì´ë„ˆë¡œ ì „ë‹¬
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
```

ìµœì¢…ì ìœ¼ë¡œ ë¸”ë£¨ ê·¸ë¦° ë°°í¬ë¥¼ ìˆ˜í–‰í•  ì…¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•œë‹¤.

```shell
#!/bin/bash

echo "ğŸš€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸..."
CURRENT=$(docker ps --filter "publish=8000" --format '{{.Names}}')

if [ -n "$CURRENT" ]; then
    if [ "$CURRENT" == "backend_blue" ]; then
        NEXT="backend_green"
        echo "ğŸŸ¢ Switching from blue to green"
    else
        NEXT="backend_blue"
        echo "ğŸ”µ Switching from green to blue"
    fi
else
    echo "âš ï¸ No currently running backend found. Defaulting to backend_blue."
    NEXT="backend_blue"
fi

echo "ğŸ”„ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ($NEXT) ì‹¤í–‰..."
docker-compose up -d --build $NEXT

echo "âš¡ Nginx ì„¤ì •ì„ ${NEXT} ì»¨í…Œì´ë„ˆë¡œ ì—…ë°ì´íŠ¸..."
cat <<EOL > ./nginx/nginx.conf
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream backend {
        server ${NEXT}:8000;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://backend;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        }
    }
}
EOL

echo "ğŸ”„ Nginx Reload..."
docker exec nginx nginx -t && docker exec nginx nginx -s reload

echo "ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
if [ -n "$CURRENT" ]; then
    docker stop $CURRENT
    docker rm $CURRENT
fi

echo "âœ… ë°°í¬ ì™„ë£Œ!"
```

í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ëŠ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•˜ê³ , ë°˜ëŒ€ ì»¨í…Œì´ë„ˆë¥¼ ìƒˆë¡œ ì‹¤í–‰í•œë‹¤.

ì—¬ê¸°ì„œ ìˆ˜ì •ëœ nginx ì„¤ì • íŒŒì¼ì´ ìƒˆë¡œ ìƒì„±ëœ ì»¨í…Œì´ë„ˆë¡œ ë°”ì¸ë”©í•˜ê³  reloadí•˜ì—¬ ë°˜ì˜í•œë‹¤. ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš°ê³  ê¸°ì¡´ ì»¨í…Œì´ë„ˆëŠ” íŠ¸ë˜í”½ì„ ë°›ì§€ ì•Šê±°ë‚˜ ì¤‘ë‹¨ëœë‹¤.

ë°°í¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ec2ì˜ ë””ë ‰í„°ë¦¬ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```
â”œâ”€â”€ .env
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ nginx
 Â Â  â””â”€â”€ nginx.conf
```

ì‹¤í–‰í•˜ëŠ” ëª…ë ¹ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```bash
docker-compose up -d --build # ì»¨í…Œì´ë„ˆ ë„ìš°ê¸°
./deploy.sh # ë¸”ë£¨-ê·¸ë¦° êµì²´
```

### íšŒê³ 

ë¡¤ë°±ì´ë‚˜ í—¬ìŠ¤ ì²´í¬ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ìƒì„± ì‹œ ê²€ì¦í•˜ê³  ë³µêµ¬í•˜ëŠ” ë°©ë²•ì´ í•„ìš”í•  ê²ƒ ê°™ë‹¤.

ë‹¤ìŒìœ¼ë¡  github actionì„ í†µí•´ ë°±ì—”ë“œë„ ë°°í¬ë¥¼ ìë™í™”í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.
